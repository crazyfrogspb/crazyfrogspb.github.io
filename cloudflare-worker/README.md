# Cloudflare Worker –¥–ª—è RAG API

–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –¥–ª—è OpenRouter API —Å CORS-–∑–∞—â–∏—Ç–æ–π –∏ rate limiting.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –¥–µ–ø–ª–æ–π

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Wrangler CLI

```bash
npm install -g wrangler
```

### 2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Cloudflare

```bash
wrangler login
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ KV namespace –¥–ª—è rate limiting

```bash
wrangler kv:namespace create "RATE_LIMIT_KV"
wrangler kv:namespace create "RATE_LIMIT_KV" --preview
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID namespace –∏ –æ–±–Ω–æ–≤–∏—Ç–µ `wrangler.toml`.

### 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ OpenRouter API –∫–ª—é—á–∞
wrangler secret put OPENROUTER_API_KEY

# –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–ª—é—á –æ—Ç OpenRouter
```

### 5. –î–µ–ø–ª–æ–π

```bash
# Development
wrangler deploy --env development

# Production
wrangler deploy --env production
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã (CORS)

–í `worker.js` –æ–±–Ω–æ–≤–∏—Ç–µ `CONFIG.ALLOWED_ORIGINS`:

```javascript
ALLOWED_ORIGINS: [
  'https://your-github-pages-domain.github.io',
  'http://localhost:4000',  // –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
  'http://127.0.0.1:4000'
]
```

### Rate Limiting

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ IP –≤ 5 –º–∏–Ω—É—Ç.

–ò–∑–º–µ–Ω–∏—Ç—å –≤ `CONFIG.RATE_LIMIT`:

```javascript
RATE_LIMIT: {
  MAX_REQUESTS: 10,
  WINDOW_MINUTES: 5
}
```

### –ú–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

```javascript
DEFAULT_MODEL: 'deepseek/deepseek-chat-v3.1:free'
```

–î–æ—Å—Ç—É–ø–Ω—ã–µ –ë–ï–°–ü–õ–ê–¢–ù–´–ï –º–æ–¥–µ–ª–∏ –Ω–∞ OpenRouter:
- `x-ai/grok-4-fast:free` (–±—ã—Å—Ç—Ä–∞—è, –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
- `deepseek/deepseek-chat-v3.1:free` (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `openai/gpt-oss-20b:free` (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ OpenAI)
- `z-ai/glm-4.5-air:free` (–∫–∏—Ç–∞–π—Å–∫–∞—è –º–æ–¥–µ–ª—å)
- `moonshotai/kimi-k2:free` (—Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä—É—Å—Å–∫–∏–º)
- `qwen/qwen3-14b:free` (Alibaba, –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è)

## API Endpoint

### POST /

**Request:**
```json
{
  "query": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ?",
  "context": [
    {
      "title": "–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ",
      "content": "–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ - —ç—Ç–æ...",
      "url": "/2022/05/18/–∞–∫—Ç–∏–≤–Ω–æ–µ-–æ–±—É—á–µ–Ω–∏–µ/"
    }
  ],
  "model": "deepseek/deepseek-chat-v3.1:free"  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏
}
```

**Response:**
```json
{
  "answer": "–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ - —ç—Ç–æ –ø–æ–¥—Ö–æ–¥ –≤ –º–∞—à–∏–Ω–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏...",
  "sources": [
    {
      "id": 1,
      "title": "–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ",
      "url": "/2022/05/18/–∞–∫—Ç–∏–≤–Ω–æ–µ-–æ–±—É—á–µ–Ω–∏–µ/",
      "excerpt": "–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ - —ç—Ç–æ..."
    }
  ],
  "usage": {
    "prompt_tokens": 150,
    "completion_tokens": 200,
    "total_tokens": 350
  }
}
```

**Error Responses:**

Rate limit:
```json
{
  "error": "rate_limit_exceeded",
  "message": "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç.",
  "retryAfter": 300
}
```

Invalid query (–Ω–µ –ø–æ —Ç–µ–º–µ):
```json
{
  "error": "Invalid query",
  "message": "–í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–∞—Ç–∏–∫–µ –±–ª–æ–≥–∞ \"–í–∞—Ä–∏–º ML\". –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ –º–∞—à–∏–Ω–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏, data science, MLOps –∏–ª–∏ –∫–∞—Ä—å–µ—Ä–µ –≤ IT."
}
```

Invalid model:
```json
{
  "error": "Invalid model",
  "message": "–ú–æ–¥–µ–ª—å gpt-4 –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏: x-ai/grok-4-fast:free, deepseek/deepseek-chat-v3.1:free, ..."
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä—ã

1. **CORS whitelist** - —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã
2. **Rate limiting** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ LLM** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç–µ–º–∞—Ç–∏–∫–µ –±–ª–æ–≥–∞
4. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏** - —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏
5. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
6. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - –º–∞–∫—Å–∏–º—É–º 8000 —Å–∏–º–≤–æ–ª–æ–≤
7. **–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç** - –æ—Ç–≤–µ—Ç—ã —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
8. **–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏** - —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Cloudflare Secrets

### üîí –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Cloudflare Dashboard
2. –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
3. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Cloudflare Dashboard

- Analytics ‚Üí Workers
- –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–æ—Å–æ–≤, –æ—à–∏–±–æ–∫, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

### –õ–æ–≥–∏

```bash
wrangler tail
```

## –°—Ç–æ–∏–º–æ—Å—Ç—å

### Cloudflare Workers

- 100,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å - –±–µ—Å–ø–ª–∞—Ç–Ω–æ
- $0.50 –∑–∞ –º–∏–ª–ª–∏–æ–Ω –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–≤–µ—Ä—Ö –ª–∏–º–∏—Ç–∞

### OpenRouter API

- **–í—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏ –ë–ï–°–ü–õ–ê–¢–ù–´–ï!** üéâ
- Deepseek Chat v3.1: –±–µ—Å–ø–ª–∞—Ç–Ω–æ
- Grok 4 Fast: –±–µ—Å–ø–ª–∞—Ç–Ω–æ
- –î—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏: –±–µ—Å–ø–ª–∞—Ç–Ω–æ

### –û—Ü–µ–Ω–∫–∞ –¥–ª—è –±–ª–æ–≥–∞

–ü—Ä–∏ –ª—é–±–æ–º —Ä–∞–∑—É–º–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤:
- Cloudflare: –±–µ—Å–ø–ª–∞—Ç–Ω–æ (–¥–æ 100k –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å)
- OpenRouter: **–ë–ï–°–ü–õ–ê–¢–ù–û** (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ free –º–æ–¥–µ–ª–∏)
- **–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: $0/–º–µ—Å—è—Ü** üí∞

## Troubleshooting

### –û—à–∏–±–∫–∞ "KV namespace not found"

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏ KV namespace –∏ –æ–±–Ω–æ–≤–∏–ª–∏ ID –≤ `wrangler.toml`.

### CORS –æ—à–∏–±–∫–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–∞—à –¥–æ–º–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ `ALLOWED_ORIGINS`.

### Rate limit –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ KV namespace –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –≤–æ—Ä–∫–µ—Ä—É.

### OpenRouter –æ—à–∏–±–∫–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

```bash
wrangler secret list
```
